<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<title> Kannel with The Huawei E160  - Vanilla Bean Creme</title>
		<!-- For responsive site
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
		-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<link rel="author" href="/humans.txt">
		<meta name="description" content="Description Goes Here">
		<link rel="stylesheet" href="/css/style.css">
		<!--[if IE 7]>
			<html class="ie7"> 
			<link rel="stylesheet" type="text/css" href="/css/font-awesome-ie7.min.css">
		<![endif]-->
		<!--[if IE 8]><html class="ie8"> <![endif]-->		
	    <!--[if lt IE 9]>
	      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	    <![endif]-->

		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
		<link rel="shortcut icon" href="ico/favicon.png">	    
	</head>
	<body>
	<!-- Header
	    ================================================== -->
	<header>

	</header>

	<div class="top-strip"></div>
<main class="content">
    <section class="container">
    	<div class="row-fluid">
    		<article class="home-icon">
				<a href="/">
					<i class="icon-home"></i> 
				</a>
			</article>
			<article class="post">
				<h5>18 January 2014</h5>
				<h2 class="content">Kannel with The Huawei E160</h2>
				<section>
					<p>I love <a href="http://www.kannel.org">Kannel</a>. Everybody who’s used It, loves It. And why wouldn’t you? It’s libre, it’s open and tt’s powerful. However, Kannel is hard to configure. Especially if Its your first time using It (let alone it being your first time using Linux). There are just too many variables you can tweak.</p>

<h3 id="my-use-case">My Use Case</h3>

<p>As I had mentioned in another post, I used Kannel to send and receive SMSs from and Android App I’ve been building for farmers.</p>

<blockquote>
  <p><strong>Note:</strong></p>
</blockquote>

<blockquote>
  <ul>
    <li>I haven’t used Kannel in large scale. Therefore, I do not know how well it scales.</li>
    <li>I only configured my instance of Kannel to send and receive SMSs and not MMSs. Although It is able to do that.</li>
  </ul>
</blockquote>

<h3 id="lego">Lego</h3>

<p>Enough chitchat. Let’s configure this badboy. I am assuming you have already installed Kannel (this shouldn’t be hard).</p>

<h4 id="lock-it-up">1. Lock it up</h4>

<p>Enough chitchat. Let’s configure this badboy. I am assuming you have already installed Kannel (this shouldn’t be hard).</p>

<ol>
  <li>Most modems, including the E160, have some sort of storage embedded in them (as an extra). Therefore, if you plug in such a modem it might either mount as a modem or a storage device.</li>
  <li>If the modem mounts in ‘modem mode’, it will probably mount as two (or more) devices in /dev/. In actual sense, one of the devices is the modem’s control port and the other is its data port.</li>
  <li>It is not guaranteed the modem’s data and control ports will be given the same names in /dev/.</li>
  <li>Kannel needs to have sufficient permissions to read and write to the modem.</li>
</ol>

<p>We therefore have to find a way to make sure that; the modem always mounts in ‘modem mode’ and the the modem’s ports are always given the same names in /dev/ every time they are mounted. We can achieve this using udev rules. We also have to make sure Kannel has sufficient permissions to write to the modem’s data port.</p>

<p>In Linux, udev rules are in /etc/udev/rules.d/. I already created rules for the Huawei E610 and saved them as <a href="https://github.com/jasonrogena/kannel_config/blob/master/etc/udev/rules.d/15-huawei-e1550.rules">15-huawei-e1550.rules</a>.</p>

<p>The first line uses <a href="https://www.archlinux.org/packages/?q=usb_modeswitch">usb_modswitch</a> to make sure that the when the modem mounts, it mounts in ‘modem mode’. The second and third line give the modem’s two ports determinant names. Kannel will be writing into the ttyUSB_utps_pcui device.</p>

<p>After creating the rules and saving the file in /etc/udev/rules.d/ you would want to (re)insert the modem onto your machine. The rules should take effect immediately. You can however confirm if the have by listing what is in /dev/ to see if ttyUSB_utps_pcui and ttyUSB_utps_modem are there.</p>

<p>We now need to add the Kannel user to the group that owns write permissions to ttyUSB_utps_pcui. To confirm if the Kannel user exists, I ran:</p>

<pre><code> cat /etc/passwd | grep kannel
</code></pre>

<p>Details of the Kannel user will show up if it actually exists.</p>

<p>We now need to find out which group owns write permissions to /dev/ttyUSB_utps_pcui. The following command should do the trick (the second line is the command’s result):</p>

<pre><code>ls -l /dev/ | grep ttyUSB_utps_pcui
&gt;&gt; crw-rw----  1 root dialout   188,   1 Jan 18 12:40 ttyUSB_utps_pcui
</code></pre>

<p>In my case, the ‘dialout’ group owns the ttyUSB_utps_pcui device. To add the Kannel user into the ‘dialout’ group, run (as root):</p>

<pre><code>usermod -a -G dialout kannel
</code></pre>

<h4 id="actual-configuration">2. Actual Configuration</h4>
<p>We can now start the actual configuration of Kannel. All Kannel configuration files are in /etc/kannel/. In my case I have two config files; kannel.conf and modems.conf.</p>

<p>All configurations in Kannel fall under groups. For instance there is a group where all the settings in regards to sending of SMSs fall under. The groups that I configured are:</p>

<ol>
  <li>core </li>
  <li>smsc </li>
  <li>smsbox </li>
  <li>sendsms-user </li>
  <li>sms-service</li>
</ol>

<p>You can read <a href="http://www.kannel.org/download/1.4.0/userguide-1.4.0/userguide.html">Kannel’s documentation</a> if you require a better explanation of this groups and other groups.</p>

<h6 id="core-group">core Group</h6>

<p>The core group contains all the Kannel admin configurations. My core group looks like this:</p>

<pre><code>group = core
admin-port = 13000
smsbox-port = 13001
admin-password = p@ssw0rd
admin-deny-ip = "*.*.*.*"
admin-allow-ip = "127.0.0.1"
#wapbox-port = 13002
#wdp-interface-name = "*"
log-file = "/var/log/kannel/kannel.log"
log-level = 0
box-deny-ip = "*.*.*.*"
box-allow-ip = "127.0.0.1"
</code></pre>

<p>The configurations are pretty straight forward. The only things here that I think need explanation are the admin-port and the smsbox-port. At this point it is important to note that all interaction with the Kannel daemon occur using HTTP. You can now guess that the admin-port is the TCP port through which admin commands can be issued to Kannel. The smsbox-port is the TCP port through which instances of the Kannel module (called smsbox) responsible for sending SMSs connect to the core Kannel daemon (called bearerbox).</p>

<p>Don’t worry, further down this post I explain how to interact with Kannel.</p>

<h6 id="smsc-group">smsc Group</h6>

<p>This group contains settings responsible for controlling the modem and Kannel’s interaction with it. My smsc group looks like this:</p>

<pre><code>group = smsc
smsc = at
modemtype = auto
device = /dev/ttyUSB_utps_pcui
my-number = +254723572302
sms-center = +254722500029
connect-allow-ip = 127.0.0.1
log-level = 0
include = /etc/kannel/modems.conf
</code></pre>

<p>As you can see, here is where we point Kannel to the device in which it will be talking to (check line 5). We also set the modem’s mobile number and <a href="http://en.wikipedia.org/wiki/Short_message_service_center">SMS center</a> here. I also point Kannel to the second config file in /etc/kannel/ here. The second config file <a href="https://github.com/jasonrogena/kannel_config/blob/master/etc/kannel/modems.conf">modems.conf</a> contains the different settings for the different well known modems that will make them work well with Kannel.</p>

<p>You can set the log level to 0 for ‘debug’, 1 for ‘info’, 2 for ‘warning, 3 for ‘error’ and 4 for ‘panic’ log levels depending on how you want it.</p>

<h6 id="smsbox-group">smsbox Group</h6>

<p>This group contains configurations for sending SMSs.</p>

<pre><code>group = smsbox
bearerbox-host = 127.0.0.1
sendsms-port = 13013
global-sender = +254723572302
log-level = 0
</code></pre>

<p>Pretty self-explanatory, huh!?</p>

<p>This group contains configurations that control how users (apps) that want to send SMSs through Kannel interact with It. Mine looks like this:</p>

<pre><code>#use http://127.0.0.1:13013/cgi-bin/sendsms?username=kannel&amp;password=kannel&amp;text=inserttexthere
group = sendsms-user
username = kannel
password = kannel
concatenation = true
max-messages = 1000
</code></pre>

<p>The username and password set here are the ones to be used to authenticate a user that wants to send SMSs using Kannel. If concatenation is set to true, messages that are longer that the maximum SMS length, the message will be sent as a <a href="http://en.wikipedia.org/wiki/Concatenated_SMS">concatenated SMS</a>.</p>

<h6 id="sms-service-group">sms-service Group</h6>

<p>This is a group of configurations that control how Kannel dispatches incoming SMSs to apps (users) that are expecting SMSs. You can set it that  all messages from a particular number will be redirected to a certain script. My sms-service group looks like this:</p>

<pre><code>group = sms-service
keyword-regex = .*
catch-all = yes
max-messages = 0
#sms-resend-retry = 0
get-url = "http://localhost/~jason/ngombe_planner/WebServer/php/kannel/sms_router.php?phone=%p&amp;text=%a"
</code></pre>

<p>In my configuration, all incoming SMSs are redirected to a PHP script that redirects the message to other PHP scripts depending on the contents of the message. As you can see in ‘get-url’ config, Kannel interacts with the PHP script by sending to it two GET variables; phone and text. The phone variable holds the sender’s number while the text variable holds the message.</p>

<h4 id="interacting-with-kannel">3. Interacting with Kannel</h4>

<p>If, for instance, I wanted to see the how many SMSs Kannel has sent so far I would do something like:</p>

<pre><code>lynx http://127.0.0.1:13000/status
</code></pre>

<p>As I had mentioned earlier, all interaction with Kannel is done using HTTP. Lynx is text base browser. You will get the same results if you visited the link in the above command in a normal browser like Chrome.</p>

<p>There are some commands to Kannel that might require authentication. For instance:</p>

<pre><code>lynx http://127.0.0.1:13000/restart?password=bacon
</code></pre>

<p>You also send SMSs using HTTP. This means that you can actually have a dedicated SMS server in the office/server room. All services running is other servers will be able to send SMSs by communicating with Kannel in the SMS server like this (here I’m assuming Kannel is running on the same machine, but you already knew that):</p>

<pre><code>lynx http://127.0.0.1:13013/cgi-bin/sendsms?username=kannel&amp;password=kannel&amp;text=I%20fucking%20love%20bacon
</code></pre>

<p>All the files I used to configure Kannel are in this <a href="https://github.com/jasonrogena/kannel_config">repo</a>.</p>

					<hr>
				</section>
            <section>
               
                      <div id="disqus_thread"></div>
                         <script type="text/javascript">
                             /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                             var disqus_shortname = 'jasonrogena'; // required: replace example with your forum shortname

                             /* * * DON'T EDIT BELOW THIS LINE * * */
                             (function() {
                                 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                                 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                             })();
                         </script>
                         <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                         <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
               
            </section>
				<section style="font-weight:bold; margin-bottom: 2em;">
					
						
				</section>
			</article>
		</div>
	</section>
</main>


	<footer>
		<div class="container">
			Jason Rogena
		</div>
	</footer>

	<!-- Footer
	    ================================================== -->

	<!-- Javascripts 
	    ================================================= -->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/custom.js"></script>

    <!-- Analytics
    ================================================== -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-54526143-1', 'auto');
        ga('send', 'pageview');
    </script>	
	</body>
</html>
