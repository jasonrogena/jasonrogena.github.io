<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>An SRE's Guide to Distributed Consensus, Part 3 | do{coffee; code;} while(true)</title><link rel=canonical href=https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-3/><meta name=description content="I am a Site Reliability Engineer currently based in Nairobi. If I'm not on my desk, I'll probably be in the kitchen or gym. I'm also a father of seven (plants). Herein lies, mostly tech-related, exploits in the form of blog posts and projects. Feel free to reach out on email or Twitter if you'd like to chat."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="An SRE's Guide to Distributed Consensus, Part 3"><meta property="og:description" content="This is the last of three posts on distributed consensus in the DevOps world. These posts are based on a presentation I gave to the Nairobi GNU/Linux Users Group. A video of the presentation can be found here.
 The first post in this series introduced distributed consensus and the second post introduced the Raft consensus algorithm. In this post, I&rsquo;ll present common DevOps problem and show how we can use distributed consensus to deal with this problem at scale."><meta property="og:type" content="article"><meta property="og:url" content="https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-07T12:00:00+00:00"><meta property="article:modified_time" content="2020-11-07T12:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="An SRE's Guide to Distributed Consensus, Part 3"><meta name=twitter:description content="This is the last of three posts on distributed consensus in the DevOps world. These posts are based on a presentation I gave to the Nairobi GNU/Linux Users Group. A video of the presentation can be found here.
 The first post in this series introduced distributed consensus and the second post introduced the Raft consensus algorithm. In this post, I&rsquo;ll present common DevOps problem and show how we can use distributed consensus to deal with this problem at scale."><link rel=stylesheet href=https://rogena.me/css/styles.8c409dff779885c83fb0de0c3286b4b235815a976616684de14d8c1162d57c5a436734edab668b543ff48c474f4ddff16f46620f6a477904be1e015c6af37d31.css integrity="sha512-jECd/3eYhcg/sN4MMoa0sjWBWpdmFmhN4U2MEWLVfFpDZzTtq2aLVD/0jEdPTd/xb0ZiD2pHeQS+HgFcavN9MQ=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rogena.me/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-2/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&text=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&is_video=false&description=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203&body=Check out this article: https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&name=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203&description=This%20is%20the%20last%20of%20three%20posts%20on%20distributed%20consensus%20in%20the%20DevOps%20world.%20These%20posts%20are%20based%20on%20a%20presentation%20I%20gave%20to%20the%20Nairobi%20GNU%2fLinux%20Users%20Group.%20A%20video%20of%20the%20presentation%20can%20be%20found%20here.%0a%20The%20first%20post%20in%20this%20series%20introduced%20distributed%20consensus%20and%20the%20second%20post%20introduced%20the%20Raft%20consensus%20algorithm.%20In%20this%20post%2c%20I%26rsquo%3bll%20present%20common%20DevOps%20problem%20and%20show%20how%20we%20can%20use%20distributed%20consensus%20to%20deal%20with%20this%20problem%20at%20scale." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&t=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#scale-out-using-cdns>Scale Out Using CDNs</a></li><li><a href=#distributed-consensus-for-rolling-updates>Distributed Consensus for Rolling Updates</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">An SRE's Guide to Distributed Consensus, Part 3</h1><div class=meta><div class=postdate><time datetime="2020-11-07 12:00:00 +0000 UTC" itemprop=datePublished>2020-11-07</time></div><div class=article-read-time><i class="far fa-clock"></i>
7 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/raft rel=tag>Raft</a>
,
<a class=tag-link href=/tags/distributed-consensus rel=tag>Distributed Consensus</a></div></div></header><div class=content itemprop=articleBody><blockquote><p>This is the last of three posts on distributed consensus in the DevOps world. These posts are based on a presentation I gave to the Nairobi GNU/Linux Users Group. A video of the presentation can be found <a href="https://www.youtube.com/watch?v=oVmitH0-LUQ&t=181s">here</a>.</p></blockquote><p>The first post in this series introduced distributed consensus and the second post introduced the Raft consensus algorithm. In this post, I&rsquo;ll present common DevOps problem and show how we can use distributed consensus to deal with this problem at scale.</p><p>Let&rsquo;s say you need to manage the deployment of software updates to your infrastructure. Some of the requirements that you need to consider include:</p><ol><li>The software updates might be large. In some cases larger than 1GB.</li><li>The software updates will be regular.</li><li>The software updates should be deployed to the entire infrastructure quickly.</li><li>The software updates should be done in a way that doesn&rsquo;t cause service interruption.</li></ol><p>So you, initially, go with the approach where when a software update is published in your artifacts repository, an automated pipeline kicks in and begins the process of deploying the software update to your servers. The deployment pipeline targets tens of servers spread out across a few availability zones within the same geographic region. The deployment pipeline rolls an update to the servers by applying the update to a small chunk of the servers at a time. It takes tens of minutes to roll an update to your entire infrastructure.</p><p><img src=/images/2020-11-07-deployment-architecture-simple.png alt="Simple Deployment Architecture"></p><p>There is no issue with each of the servers downloading the software updates from the centralized artifacts repository. Over time, however, your business grows and so does the need to have more servers in your fleet. You scale up your infrastructure to hundreds of servers spread out across different availability zones in different geographic regions. Some cracks in your deployment process begin to show:</p><ol><li>You notice that the artifacts repository is your biggest bottle-neck. The repository&rsquo;s upload link speed limits how fast the software updates can be served to servers at the same time.</li><li>You also notice that software updates take longer to download in availability zones that are geographically further from the region your artifacts repository is deployed in.</li><li>Another thing you notice is that since your availability zones now have more servers in them than before, the availability zones' downlinks become congested whenever the deployment pipeline kicks in because you now have more servers in the same availability zone trying to download the software update at the same time. Services deployed in your infrastructure experience reliability issues whenever a large software update is rolling because they aren&rsquo;t able to fetch data from clients fast enough.</li></ol><h3 id=scale-out-using-cdns>Scale Out Using CDNs</h3><p>So, you decide to scale out your software release architecture. The updated architecture includes a CDN node running in each of the regions your infrastructure is deployed in.</p><p><img src=/images/2020-11-07-deployment-architecture-with-cdn.png alt="Deployment Architecture with CDN"></p><p>When a software update is being rolled out to your infrastructure, the servers now download the software updates from the CDN node closest to them. The updated approach definitely works better. The downlinks in your availability zones, however, still get congested whenever a large software update is being deployed.</p><p>You scale your fleet to thousands of servers. Your software update process also starts becoming more complicated. For instance, because you now have to deal with far more advanced adversaries, you make it a requirement that a software update&rsquo;s cryptographic signature has to be verified before the software update is applied to a server.</p><p>Also, since your fleet is now composed of different kinds of servers (let&rsquo;s say Intel and AMD servers), you now have to confirm that an update was successfully deployed and is running okay for each of the kinds of servers you have deployed.</p><p>You notice that it is harder to coordinate the deployment process, centrally, from your Continuous Delivery tool, especially in cases where a deployment check has failed for a subset of your infrastructure and you need to rollback to the previous release for just this subset of servers. It&rsquo;s harder because your centralized CD tool needs to get a status update from each of the thousands of servers as a deployment is running.</p><p>The CD tool also has to figure out which servers to rollback if a certain check fails on a server. For example, if the pre-flight checks pass on your first targeted Intel server but fail on your first targeted AMD server, it is safe to assume that it will fail on other AMD servers, so roll back the release on just the AMD server but continue the deployment on the Intel servers. This is just one of the permutations you have to deal with.</p><h3 id=distributed-consensus-for-rolling-updates>Distributed Consensus for Rolling Updates</h3><p>How can distributed consensus help scale the deployment process further?</p><p>Here&rsquo;s how I&rsquo;d do it; I&rsquo;d divide the servers into homogeneous groups. For instance, if the main distinguishing characteristics for servers in my fleet are the processor architecture and availability zone, then I&rsquo;d have a group for each architecture in each availability zone. There would therefore be one group consisting of only Intel servers in availability zone A and another group for AMD servers in availability zone A. There would be a third group for Intel servers running in availability zone B and a forth group for AMD servers in availability zone B.</p><p>Each of these groups would coordinate the deployment process independently. For the group coordination to be reliable, I&rsquo;d use a distributed consensus algorithm like Raft.</p><p>And&mldr; in order for me to use a distributed consensus algorithm like Raft to coordinate the software deployment process, I will need to represent the process as a state machine.</p><p><img src=/images/2020-11-07-software-update-state-machine-diagram.png alt="Software Update State Machine Diagram"></p><p>It turns out representing the software deployment process as a state machine isn&rsquo;t too hard. The state machine diagram on this slide shows a hypothetical complex deployment process that involves cryptographic verification of an update, then rolling the release to 1/10th of the servers in a group at a time, and running pre-flight checks after the update is applied to a server.</p><p>If any of the steps fail, the group begins the process of rolling back to the previous software release. Now that the deployment process is represented as a state machine, how would the coordination actually work?</p><p>We&rsquo;d have a software coordination service running in all the servers. The service would use Raft for distributed consensus. The servers in a group would elect a leader. The servers would also act as both the clients and servers in the group.</p><p>The leader, once elected, would be responsible for checking for software updates. When an update becomes available, it sends a command to the group of servers requesting for the state machine to change to the &ldquo;Group Marked as Running Old Release&rdquo; state. Once a majority of the servers in the group have this command in their log, the leader would go ahead and commit to the state by updating an infrastructure registry indicating that the group of servers is running an outdated version of the software.</p><p>The leader would then issue another command to transition from the &ldquo;Group Marked as Running Old Release&rdquo; state to the &ldquo;New Release Downloaded in Leader&rdquo; state. Once there&rsquo;s a consensus from a majority of the servers that the group can transition to the state, the leader would commit to this by downloading the software update from the closest CDN node.</p><p>At this point the leader would cryptographically check whether the software update is valid and if so would issue another command to the group requesting that the group transitions to the &ldquo;New Release Downloaded to the 1st 1/10th of Servers&rdquo; state. When a consensus is reached the leader would proceed to commit to this by selecting the first 1/10th of the servers then requesting them to download the update.</p><p>Once all the selected 1/10th of servers all confirm that they have the software update downloaded, the leader would issue a command requesting the group to transition into the next state.</p><p>This kind of coordination would be done until a point where the group of servers is in the &ldquo;Group Running Current Release&rdquo; state or a rollback has been done and the group is back to the &ldquo;Group Marked as Running Old Release&rdquo; state and some form of intervention is needed.</p><p>If ever the leader were to go down during the software update process, there would be a graceful transition to another leader since a majority of the servers are aware of the current state of the deployment process. The new leader would just pick up from where the old leader left off.</p><p>There you have it. That&rsquo;s how I&rsquo;d use distributed consensus to run the software update process in a massively scaled set of servers.</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><ul><li><a href=#scale-out-using-cdns>Scale Out Using CDNs</a></li><li><a href=#distributed-consensus-for-rolling-updates>Distributed Consensus for Rolling Updates</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&text=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&is_video=false&description=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203&body=Check out this article: https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&name=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203&description=This%20is%20the%20last%20of%20three%20posts%20on%20distributed%20consensus%20in%20the%20DevOps%20world.%20These%20posts%20are%20based%20on%20a%20presentation%20I%20gave%20to%20the%20Nairobi%20GNU%2fLinux%20Users%20Group.%20A%20video%20of%20the%20presentation%20can%20be%20found%20here.%0a%20The%20first%20post%20in%20this%20series%20introduced%20distributed%20consensus%20and%20the%20second%20post%20introduced%20the%20Raft%20consensus%20algorithm.%20In%20this%20post%2c%20I%26rsquo%3bll%20present%20common%20DevOps%20problem%20and%20show%20how%20we%20can%20use%20distributed%20consensus%20to%20deal%20with%20this%20problem%20at%20scale." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-3%2f&t=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%203" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2021 Jason Rogena</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>