<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Sending App Data Over SMS on Android | do{coffee; code;} while(true)</title>
<link rel=canonical href=https://rogena.me/posts/2013-12-22-sending-app-data-over-sms-on-android/><meta name=description content="I am a Site Reliability Engineer currently based in Dublin. If I'm not at my desk, I'll probably be in the kitchen or gym. I'm also a father of seven (plants). Herein lies, mostly tech-related, exploits in the form of blog posts and projects. Feel free to reach out through email or Twitter if you'd like to chat."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Sending App Data Over SMS on Android"><meta property="og:description" content="For some time now I&rsquo;ve been working on an Android app that is going to be used by small scale farmers in East Africa. We expect that most of the farmers will not have an internet connection. Hell, most of them won&rsquo;t have android phones. But that&rsquo;s a story for another day. So, for a proof of concept, the app I&rsquo;m making should roll back to sending data using SMS when no HTTP connection is available."><meta property="og:type" content="article"><meta property="og:url" content="https://rogena.me/posts/2013-12-22-sending-app-data-over-sms-on-android/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-22T00:00:00+00:00"><meta property="article:modified_time" content="2013-12-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sending App Data Over SMS on Android"><meta name=twitter:description content="For some time now I&rsquo;ve been working on an Android app that is going to be used by small scale farmers in East Africa. We expect that most of the farmers will not have an internet connection. Hell, most of them won&rsquo;t have android phones. But that&rsquo;s a story for another day. So, for a proof of concept, the app I&rsquo;m making should roll back to sending data using SMS when no HTTP connection is available."><link rel=stylesheet href=https://rogena.me/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q==" crossorigin=anonymous><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rogena.me/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://rogena.me/posts/2014-01-18-kannel-and-the-huawei-e160/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&text=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&title=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&is_video=false&description=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Sending%20App%20Data%20Over%20SMS%20on%20Android&body=Check out this article: https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&title=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&title=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&name=Sending%20App%20Data%20Over%20SMS%20on%20Android&description=For%20some%20time%20now%20I%26rsquo%3bve%20been%20working%20on%20an%20Android%20app%20that%20is%20going%20to%20be%20used%20by%20small%20scale%20farmers%20in%20East%20Africa.%20We%20expect%20that%20most%20of%20the%20farmers%20will%20not%20have%20an%20internet%20connection.%20Hell%2c%20most%20of%20them%20won%26rsquo%3bt%20have%20android%20phones.%20But%20that%26rsquo%3bs%20a%20story%20for%20another%20day.%20So%2c%20for%20a%20proof%20of%20concept%2c%20the%20app%20I%26rsquo%3bm%20making%20should%20roll%20back%20to%20sending%20data%20using%20SMS%20when%20no%20HTTP%20connection%20is%20available." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&t=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#architecture>Architecture</a></li><li><a href=#make-it-work-well-over-http>Make it work well over HTTP</a></li><li><a href=#the-sms-server>The SMS Server</a></li><li><a href=#rolling-back-to-sms-on-the-android-app>Rolling back to SMS on the Android App</a></li><li><a href=#whats-next>What&rsquo;s next</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Sending App Data Over SMS on Android</h1><div class=meta><div class=postdate><time datetime="2013-12-22 00:00:00 +0000 UTC" itemprop=datePublished>2013-12-22</time></div><div class=article-read-time><i class="far fa-clock"></i>
5 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/sms rel=tag>SMS</a></div></div></header><div class=content itemprop=articleBody><p>For some time now I&rsquo;ve been working on <a href=https://github.com/jasonrogena/ngombe_planner-android>an Android app</a> that is going to be used by small scale farmers in East Africa. We expect that most of the farmers will not have an internet connection. Hell, most of them won&rsquo;t have android phones. But that&rsquo;s a story for another day. So, for a proof of concept, the app I&rsquo;m making should roll back to sending data using SMS when no HTTP connection is available. Here some notes on how to do it:</p><h3 id=architecture>Architecture</h3><p>You&rsquo;d want to follow an architectural styl, such as <a href=http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm>REpresentational State Transfer</a>, that explicitly defines the types and structures of messages to be sent between Client and Server. This is very important because you want to keep the intereactions as clean as possible.</p><p>In this instance, I did not go the REST way. However, I made up a simple &lsquo;Protocol&rsquo; defining intereactions between the Client (Android App) and the Server. Here it goes: <em>All messages sent between the Server and the Client are either json strings or integers. The integers represent predefined acknowledgement and error codes</em>.</p><h3 id=make-it-work-well-over-http>Make it work well over HTTP</h3><p>As much as I would have wanted to start implementing the SMS functionality from the get go I had to first get the requirements right first. Blame that on the client. So I built, we reviewed. Then I built some more and we reviewed again until all the features were working (although all interactions with the server were through a http connection).</p><p>One thing, however, that I had to do was to make sure the app was as modular as possible. Each important function (eg handling notifications or interaction with the server) was handled by one class. For instance all interactions with the server are handled by <a href=https://github.com/jasonrogena/ngombe_planner-android/blob/master/NgombePlanner/src/main/java/org/cgiar/ilri/np/farmer/backend/DataHandler.java>DataHandler.java</a>.</p><h3 id=the-sms-server>The SMS Server</h3><p>When everything was working fine over HTTP and I was sure it was time to implement message transmission over SMS, we had to choose Server Side Software for handling SMSs. My boss chose <a href=http://www.kannel.org>Kannel</a>. I wouldn&rsquo;t have chosen anything else. Kannel is free and open. Honestly, I would not recommend Ozeki to anyone. Kannel is a bit hard to configure but once you get things running it is bliss.</p><p>Here&rsquo;s <a href=https://jasonrogena.github.io/2014/01/18/kannel-and-the-huawei-e160.html>another post</a> I wrote on configuring Kannel.</p><p>We have two servers in the office, one has all the PHP scripts that interact with the Android app and the other runs Kannel. To make things less complicated I&rsquo;ll call the server running the PHP scripts Azizi and the one running Kannel KServer. KServer has a Huawei E160 HSPA modem plugged into it. Not the best modem but it works. The KServer acts like a proxy, re-routing SMSs from the Andriod app to Azizi and routing responses from Azizi to the Android app via SMS.</p><h3 id=rolling-back-to-sms-on-the-android-app>Rolling back to SMS on the Android App</h3><p>Sending SMSs from the Android app is pretty simple. When DataHandler is called, it checks whether it can connect to Azizi over HTTP. It sends the data using SMS if it cannot directly connect to Azizi. Code snippet below shows the method in DataHandler responsible for determining if data should be sent using HTTP or SMS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>sendDataToServer</span>(Context context, String jsonString, String appendedURL, booleanwaitForResponse) {
</span></span><span style=display:flex><span>    String response;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(checkNetworkConnection(context)){
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> sendDataUsingHttpConnection(jsonString, appendedURL);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> sendDataUsingSMS(context, jsonString, appendedURL, waitForResponse);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The sendDataUsingSMS method is pretty simple. I first created a new <a href=http://developer.android.com/reference/android/telephony/gsm/SmsManager.html>SmsManager</a> Object. Note from the code snippet below that I intend to send multipart SMSs instead of regular SMSs. This is because the text being sent to the server might be greater than 150 characters (limit for one SMS).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>SmsManager smsManager <span style=color:#f92672>=</span> SmsManager.<span style=color:#a6e22e>getDefault</span>();
</span></span><span style=display:flex><span>String message <span style=color:#f92672>=</span> appendedURL<span style=color:#f92672>+</span>SMS_DELIMITER<span style=color:#f92672>+</span>jsonString;
</span></span><span style=display:flex><span>ArrayList<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> multipartMessage <span style=color:#f92672>=</span> smsManager.<span style=color:#a6e22e>divideMessage</span>(message);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> noOfParts <span style=color:#f92672>=</span> multipartMessage.<span style=color:#a6e22e>size</span>();
</span></span></code></pre></div><p>Then I initialize three <a href=http://developer.android.com/reference/android/content/BroadcastReceiver.html>BroadcastReceivers</a>. Basically, what Broadcast receivers do is listen for broadcasted Intents. For instance when an SMS is sent, Android broadcasts the Intent. All BroadcastReceivers that registered to listen for that particular intent will get the broadcast message from Android.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>MistroSMSSentReceiver mistroSMSSentReceiver <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MistroSMSSentReceiver(message, noOfParts);    
</span></span><span style=display:flex><span>context.<span style=color:#a6e22e>registerReceiver</span>(mistroSMSSentReceiver, <span style=color:#66d9ef>new</span> IntentFilter(ACTION_SMS_SENT));
</span></span><span style=display:flex><span>MistroSMSDeliveredReceiver mistroSMSDeliveredReceiver <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MistroSMSDeliveredReceiver(message, noOfParts);
</span></span><span style=display:flex><span>context.<span style=color:#a6e22e>registerReceiver</span>(mistroSMSDeliveredReceiver, <span style=color:#66d9ef>new</span> IntentFilter(ACTION_SMS_DELIVERED));
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(waitForResponse){<span style=color:#75715e>//method will be waiting for a response sms from the server</span>
</span></span><span style=display:flex><span>    MistroSMSReceiver mistroSMSReceiver <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MistroSMSReceiver();
</span></span><span style=display:flex><span>    IntentFilter smsReceivedIntentFilter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> IntentFilter(ACTION_SMS_RECEIVED);
</span></span><span style=display:flex><span>    smsReceivedIntentFilter.<span style=color:#a6e22e>addAction</span>(<span style=color:#e6db74>&#34;android.provider.Telephony.SMS_RECEIVED&#34;</span>);
</span></span><span style=display:flex><span>    context.<span style=color:#a6e22e>registerReceiver</span>(mistroSMSReceiver, smsReceivedIntentFilter);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As I was saying, I initialize three BroadcastReceivers:</p><ol><li>MistroSMSSentReceiver - That listens for when an SMS is sent</li><li>MistroSMSDeliveredReceiver - That listens for when an SMS is delivered</li><li>MistroSMSReceiver - That listens for when an SMS is received</li></ol><p>All three BroadcastReceivers are inner classes in DataHandler.java that extend BroadcastReceiver.</p><p>You might notice from the code snippet above that; MistroSMSSent Receiver will be listening for an intent with the <em>ACTION_SMS_SENT</em> message, MistroSMSDeliveredReceiver will be listening for an intent with the <em>ACTION_SMS_DELIVERED</em> message, and MistroSMSReceiver will be listening for an intent with the message <em>ACTION_SMS_RECEIVED</em>.</p><p>Then I register the MistroSMSSentReceiver and MistroSMSDeliveredReceiver for each of the SMS fragments to be sent.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ArrayList<span style=color:#f92672>&lt;</span>PendingIntent<span style=color:#f92672>&gt;</span> sentPendingIntents <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>PendingIntent<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>ArrayList<span style=color:#f92672>&lt;</span>PendingIntent<span style=color:#f92672>&gt;</span> deliveredPendingIntents <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>PendingIntent<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i<span style=color:#f92672>&lt;</span>noOfParts; i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>    PendingIntent newSentPE <span style=color:#f92672>=</span> PendingIntent.<span style=color:#a6e22e>getBroadcast</span>(context, 0, <span style=color:#66d9ef>new</span> Intent(ACTION_SMS_SENT), 0);
</span></span><span style=display:flex><span>    sentPendingIntents.<span style=color:#a6e22e>add</span>(newSentPE);
</span></span><span style=display:flex><span>    PendingIntent newDeliveredPE <span style=color:#f92672>=</span> PendingIntent.<span style=color:#a6e22e>getBroadcast</span>(context, 0, <span style=color:#66d9ef>new</span> Intent(ACTION_SMS_DELIVERED), 0);
</span></span><span style=display:flex><span>    deliveredPendingIntents.<span style=color:#a6e22e>add</span>(newDeliveredPE);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally I send the SMS and wait for KServer to send back the response. It&rsquo;s that simple!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>smsManager.<span style=color:#a6e22e>sendMultipartTextMessage</span>(SMS_SERVER_ADDRESS, <span style=color:#66d9ef>null</span>, multipartMessage, sentPendingIntents, deliveredPendingIntents);
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(waitForResponse){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> currTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> timeDiff <span style=color:#f92672>=</span> currTime <span style=color:#f92672>-</span> startTime;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(getSharedPreference(context, SP_KEY_SMS_RESPONSE,<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>length</span>()<span style=color:#f92672>&gt;</span>0){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> getSharedPreference(context, SP_KEY_SMS_RESPONSE,<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(timeDiff<span style=color:#f92672>&gt;</span>SMS_RESPONSE_TIMEOUT){
</span></span><span style=display:flex><span>            Log.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;SMS response timeout exceeded&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ACKNOWLEDGE_OK;
</span></span><span style=display:flex><span>}    smsManager.<span style=color:#a6e22e>sendMultipartTextMessage</span>(SMS_SERVER_ADDRESS, <span style=color:#66d9ef>null</span>, multipartMessage, sentPendingIntents, deliveredPendingIntents);
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(waitForResponse){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> currTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> timeDiff <span style=color:#f92672>=</span> currTime <span style=color:#f92672>-</span> startTime;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(getSharedPreference(context, SP_KEY_SMS_RESPONSE,<span style=color:#e6db74>&#34;&#34;</span>).<span style=color:#a6e22e>length</span>()<span style=color:#f92672>&gt;</span>0){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> getSharedPreference(context, SP_KEY_SMS_RESPONSE,<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(timeDiff<span style=color:#f92672>&gt;</span>SMS_RESPONSE_TIMEOUT){
</span></span><span style=display:flex><span>            Log.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;SMS response timeout exceeded&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ACKNOWLEDGE_OK;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see from the code above, waiting for KServer&rsquo;s response is an endless loop that terminates only when the ENTIRE response is received (put inside the SharedPreference <em>SP_KEY_SMS_RESPONSE</em>) or when it timesout.</p><p>I say ENTIRE because the server might respond with a large message that will be split into more than one SMSs. What MistroSMSReceiver does to handle this is:</p><ul><li>It listens for when an SMS is received.</li><li>If an SMS is received and the SMS is from KServer, it first gets the value of the SharedPreference <em>SP_KEY_SMS_CACHE</em> (which has a default value of an empty string), then it appends the SMS to the value of <em>SP_KEY_SMS_CACHE</em> then:</li><li>IT checks for whether the resultant message is a valid json string or if it one of the predefined flags.</li><li>If so the message is saved in the SharedPreference <em>SP_KEY_SMS_RESPONSE</em>.</li><li>Otherwise the message is cached in the SharedPreference <em>SP_KEY_SMS_CACHE</em> while MistroSMSReceiver waits for the rest of the SMS fragments.</li></ul><h3 id=whats-next>What&rsquo;s next</h3><p>There are still some things that I need to figure out:</p><ol><li>How to ensure the order of SMSs (making up a split message) is maintained when reconstructing a message.</li><li>How to compress messages before sending them over SMS. Here&rsquo;s a <a href=http://www.davidhampgonsalves.com/Compress-JSON.js/>nice post</a> how to do it.</li></ol></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><ul><li><a href=#architecture>Architecture</a></li><li><a href=#make-it-work-well-over-http>Make it work well over HTTP</a></li><li><a href=#the-sms-server>The SMS Server</a></li><li><a href=#rolling-back-to-sms-on-the-android-app>Rolling back to SMS on the Android App</a></li><li><a href=#whats-next>What&rsquo;s next</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&text=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&title=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&is_video=false&description=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Sending%20App%20Data%20Over%20SMS%20on%20Android&body=Check out this article: https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&title=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&title=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&name=Sending%20App%20Data%20Over%20SMS%20on%20Android&description=For%20some%20time%20now%20I%26rsquo%3bve%20been%20working%20on%20an%20Android%20app%20that%20is%20going%20to%20be%20used%20by%20small%20scale%20farmers%20in%20East%20Africa.%20We%20expect%20that%20most%20of%20the%20farmers%20will%20not%20have%20an%20internet%20connection.%20Hell%2c%20most%20of%20them%20won%26rsquo%3bt%20have%20android%20phones.%20But%20that%26rsquo%3bs%20a%20story%20for%20another%20day.%20So%2c%20for%20a%20proof%20of%20concept%2c%20the%20app%20I%26rsquo%3bm%20making%20should%20roll%20back%20to%20sending%20data%20using%20SMS%20when%20no%20HTTP%20connection%20is%20available." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2frogena.me%2fposts%2f2013-12-22-sending-app-data-over-sms-on-android%2f&t=Sending%20App%20Data%20Over%20SMS%20on%20Android" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2024 Jason Rogena</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>