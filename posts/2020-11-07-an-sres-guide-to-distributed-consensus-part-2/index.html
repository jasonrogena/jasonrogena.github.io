<!doctype html><html lang=en-us>
<head>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> An SRE's Guide to Distributed Consensus, Part 2 | do{coffee; code;} while(true)</title>
<link rel=canonical href=https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-2/>
<meta name=description content="I am a Site Reliability Engineer currently based in Dublin. If I'm not at my desk, I'll probably be in the kitchen or gym. I'm also a father of seven (plants). Herein lies, mostly tech-related, exploits in the form of blog posts and projects. Feel free to reach out through email or Twitter if you'd like to chat.">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta property="og:title" content="An SRE's Guide to Distributed Consensus, Part 2">
<meta property="og:description" content="This is the second of three posts on distributed consensus in the DevOps world. These posts are based on a presentation I gave to the Nairobi GNU/Linux Users Group. A video of the presentation can be found here.
 The first post in this series introduced distributed consensus. I&rsquo;ll introduce the Raft consensus algorithm in this post and try to explain how it handles distributed consensus.
The Raft algorithm is broken down into three parts.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-2/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-11-07T11:00:00+00:00">
<meta property="article:modified_time" content="2020-11-07T11:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="An SRE's Guide to Distributed Consensus, Part 2">
<meta name=twitter:description content="This is the second of three posts on distributed consensus in the DevOps world. These posts are based on a presentation I gave to the Nairobi GNU/Linux Users Group. A video of the presentation can be found here.
 The first post in this series introduced distributed consensus. I&rsquo;ll introduce the Raft consensus algorithm in this post and try to explain how it handles distributed consensus.
The Raft algorithm is broken down into three parts.">
<link rel=stylesheet href=https://rogena.me/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q==" crossorigin=anonymous><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=icon type=image/png href=https://rogena.me/images/favicon.ico>
</head>
<body class="max-width mx-auto px3 ltr">
<div class="content index py4">
<div id=header-post>
<a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu>
<span id=nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>All Posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
</span>
<br>
<span id=actions>
<ul>
<li>
<a class=icon href=https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-1/ aria-label=Previous>
<i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=https://rogena.me/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-3/ aria-label=Next>
<i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# aria-label=Share>
<i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i>
</a>
</li>
</ul>
<span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span>
</span>
<br>
<div id=share style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f" aria-label=Facebook>
<i class="fab fa-facebook" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&text=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Twitter>
<i class="fab fa-twitter" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Linkedin>
<i class="fab fa-linkedin" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&is_video=false&description=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Pinterest>
<i class="fab fa-pinterest" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202&body=Check out this article: https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f" aria-label=Email>
<i class="fas fa-envelope" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Pocket>
<i class="fab fa-get-pocket" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=reddit>
<i class="fab fa-reddit" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&name=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202&description=This%20is%20the%20second%20of%20three%20posts%20on%20distributed%20consensus%20in%20the%20DevOps%20world.%20These%20posts%20are%20based%20on%20a%20presentation%20I%20gave%20to%20the%20Nairobi%20GNU%2fLinux%20Users%20Group.%20A%20video%20of%20the%20presentation%20can%20be%20found%20here.%0a%20The%20first%20post%20in%20this%20series%20introduced%20distributed%20consensus.%20I%26rsquo%3bll%20introduce%20the%20Raft%20consensus%20algorithm%20in%20this%20post%20and%20try%20to%20explain%20how%20it%20handles%20distributed%20consensus.%0aThe%20Raft%20algorithm%20is%20broken%20down%20into%20three%20parts." aria-label=Tumblr>
<i class="fab fa-tumblr" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&t=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label="Hacker News">
<i class="fab fa-hacker-news" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=toc>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#leader-election>Leader Election</a></li>
<li><a href=#log-replication>Log Replication</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</span>
</div>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<header>
<h1 class=posttitle itemprop="name headline">
An SRE's Guide to Distributed Consensus, Part 2
</h1>
<div class=meta>
<div class=postdate>
<time datetime="2020-11-07 11:00:00 +0000 UTC" itemprop=datePublished>2020-11-07</time>
</div>
<div class=article-read-time>
<i class="far fa-clock"></i>
6 minute read
</div>
<div class=article-tag>
<i class="fas fa-tag"></i>
<a class=tag-link href=/tags/raft rel=tag>Raft</a>
,
<a class=tag-link href=/tags/distributed-consensus rel=tag>Distributed Consensus</a>
</div>
</div>
</header>
<div class=content itemprop=articleBody>
<blockquote>
<p>This is the second of three posts on distributed consensus in the DevOps world. These posts are based on a presentation I gave to the Nairobi GNU/Linux Users Group. A video of the presentation can be found <a href="https://www.youtube.com/watch?v=oVmitH0-LUQ&t=181s">here</a>.</p>
</blockquote>
<p>The <a href=/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-1>first post</a> in this series introduced distributed consensus. I&rsquo;ll introduce the Raft consensus algorithm in this post and try to explain how it handles distributed consensus.</p>
<p>The Raft algorithm is broken down into three parts. The first part is leader election where the nodes in a cluster elect one of them to be their leader. The second part is log replication which handles how commands are gotten from the clients, sent to the nodes in the distributed system, and finally safely applied to their state machines. The third part (called safety) deals with how to handle certain edge cases during leader election and log replication. Don&rsquo;t worry. The role of the leader in Raft will become clear when I explain how log replication works.</p>
<p><img src=/images/2020-11-07-raft.png alt=Raft></p>
<p>For the purposes of this post, I will only focus on explaining a bit of how leader election and log replication work in Raft. I will, however, not cover anything on safety. I highly encourage you to visit <a href=http://thesecretlivesofdata.com/raft/>this site</a> for a visual explanation of how Raft handles leader election, log replication, and safety.</p>
<h3 id=leader-election>Leader Election</h3>
<p>In the last section, I explained the architecture of a distributed system in Raft where each of the nodes is expected to have a log and a state machine. Apart from each node having a log and a state machine, they also have an integer counter called a term. This counter is what is used to distinguish a past leader from a current leader. Each of the nodes have the initial value of their term set to 1.</p>
<p>Nodes in the cluster can be in one of three states at any one particular time; they can either be a leader, a candidate, or a follower. When a node joins the cluster, it joins as a follower. The first thing it does is start a count down (called an election timeout) which lasts an arbitrary number of milliseconds. Each node controls how long its election timeout should last. If the election timeout expires before the leader of the cluster sends a message to it, the nodes starts an election.</p>
<p>To start an election, a node changes its state to candidate, it then increments its term by one, votes for itself, then sends a request to all of the nodes in the cluster asking for their vote.</p>
<p><img src=/images/2020-11-07-follower.png alt=Follower></p>
<p>When a node receives an election request from a candidate in the cluster, it evaluates whether it should vote for the candidate. One of the conditions it checks is whether the candidate&rsquo;s term is greater than its own. It will only vote for the the candidate if this is true. If all the conditions are met, the node changes its term to that of the candidate then sends its vote back to the candidate.</p>
<p>When a candidate receives a vote from a node, it evaluates whether the total number of votes it has gotten so far in its current term is 50% of all nodes plus 1. If so, it sends out a request to all the nodes (including those that didn&rsquo;t vote for it) indicating that it is now the leader for the term. Even after a leader is gotten or discovered, every follower and candidate continues to run their election timeout. They reset the timeout whenever they receive a message from the leader. This is done so that a node can be able to discover when the leader is unavailable so that it can start a new election to become the new leader.</p>
<p>Raft caters for not only the happy path, but also edge cases that might occur in leader election. The diagram on this slide shows the three node states and what makes a node transition from one of the states to another. The happy path is; that a node will start as a follower, its election timeout would expire, it would then change state to candidate then once it has received a majority of the votes, it changes state to leader.</p>
<p>However, if for instance, a candidate does not receive a majority of the votes before its election timeout expires, it restarts the election. Another edge case is when a node thinks its the leader then receives a message from a leader with a higher term, it changes its state back to follower.</p>
<p><img src=/images/2020-11-07-raft-leader-election.png alt="Raft Leader Election"></p>
<p>I recommend you watching <a href="https://youtu.be/oVmitH0-LUQ?t=979">this</a> section of my presentation for a visual explanation of how leader election works.</p>
<h3 id=log-replication>Log Replication</h3>
<p>Log replication handles; how commands are gotten from the clients, sent to the nodes in the distributed system, and finally safely applied on their state machines.</p>
<p><img src=/images/2020-11-07-log-replication.jpg alt="Log Replication"></p>
<p>It is, first, important to note that the leader is the only node allowed to receive commands from clients. This means that, either the clients should be aware which node is the current leader, or some mechanism should be built where if any of the followers receives a command from a client they proxy this command to the leader.</p>
<p>When a command is received by the leader, the leader will first append the command into its log. The leader will then forward the command to all the other nodes in the cluster. It does this using what is called an AppendEntries request. The AppendEntries request contains, apart from the command, the leader&rsquo;s current term and metadata of the command in the leader&rsquo;s log that appears right before the command sent in the request. The metadata for the previous log entry includes the index of the command in the log, and the term the command was received.</p>
<p>When a follower receives an AppendEntries request from the leader, it first checks whether its safe to append the command in the request into its own log Two of the checks done are; whether the follower&rsquo;s term is the same as the leader&rsquo;s term and, using the metadata in the AppendEntries request, whether what the leader indicated as the command saved in its log right before the command in the request also exists in the follower&rsquo;s log (but as the last entry).</p>
<p>If the follower is able to insert the command to its log, it does so then sends back a response to the leader indicating that it has inserted the command into its log. When the leader receives back a majority positive responses from followers indicating the command was successfully inserted into their logs, it applies the command into its state machine, marks the command as committed in its log, then sends the state machine&rsquo;s output back to the client.</p>
<p>The next AppendEntries request the leader sends to the followers will indicate that it has applied this command into its state machine. It is only then that the followers will also apply the command into their state machines. Raft uses this approach of first confirming that a majority of the nodes have a command in their log before applying the command in the state machines so that there is a general consensus of what the cluster expects the state machines should look like at any particular time. This is good because if the leader were to go down, you would want a majority of the rest of the nodes to know what the leader had likely applied to its state machine.</p>
<p>Note that the leader will send an AppendEntries request that doesn&rsquo;t have any command to its followers as a form of heartbeat to assure the followers that it is still alive. It does this whenever the distributed system hasn&rsquo;t received any command from its clients within a period of time. This time period is normally set to less than what is expected to be the election timeout in the nodes. Raft does this to prevent followers from starting an election because they didn&rsquo;t receive any message from the leader before their election timeout expired.</p>
<p>I recommend you watching <a href="https://youtu.be/oVmitH0-LUQ?t=1739">this</a> section of my presentation for a visual explanation of how log replication works.</p>
<p>In the <a href=/posts/2020-11-07-an-sres-guide-to-distributed-consensus-part-3>next post</a>, I&rsquo;ll explain how you can use distributed consensus to handle rolling software updates.</p>
</div>
</article>
<div id=footer-post-container>
<div id=footer-post>
<div id=nav-footer style=display:none>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>All Posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
</div>
<div id=toc-footer style=display:none>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#leader-election>Leader Election</a></li>
<li><a href=#log-replication>Log Replication</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<div id=share-footer style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f" aria-label=Facebook>
<i class="fab fa-facebook fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&text=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Twitter>
<i class="fab fa-twitter fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Linkedin>
<i class="fab fa-linkedin fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&is_video=false&description=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Pinterest>
<i class="fab fa-pinterest fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202&body=Check out this article: https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f" aria-label=Email>
<i class="fas fa-envelope fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=Pocket>
<i class="fab fa-get-pocket fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&title=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label=reddit>
<i class="fab fa-reddit fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&name=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202&description=This%20is%20the%20second%20of%20three%20posts%20on%20distributed%20consensus%20in%20the%20DevOps%20world.%20These%20posts%20are%20based%20on%20a%20presentation%20I%20gave%20to%20the%20Nairobi%20GNU%2fLinux%20Users%20Group.%20A%20video%20of%20the%20presentation%20can%20be%20found%20here.%0a%20The%20first%20post%20in%20this%20series%20introduced%20distributed%20consensus.%20I%26rsquo%3bll%20introduce%20the%20Raft%20consensus%20algorithm%20in%20this%20post%20and%20try%20to%20explain%20how%20it%20handles%20distributed%20consensus.%0aThe%20Raft%20algorithm%20is%20broken%20down%20into%20three%20parts." aria-label=Tumblr>
<i class="fab fa-tumblr fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2frogena.me%2fposts%2f2020-11-07-an-sres-guide-to-distributed-consensus-part-2%2f&t=An%20SRE%27s%20Guide%20to%20Distributed%20Consensus%2c%20Part%202" aria-label="Hacker News">
<i class="fab fa-hacker-news fa-lg" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=actions-footer>
<a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu>
<i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC>
<i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share>
<i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a>
</div>
</div>
</div>
<footer id=footer>
<div class=footer-left>
Copyright &copy; 2022 Jason Rogena
</div>
<div class=footer-right>
<nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>All Posts</a></li>
<li><a href=/tags>Tags</a></li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
</html>