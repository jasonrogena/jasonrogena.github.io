<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Matatus; Route Planning Using Neo4J | do{coffee; code;} while(true)</title><link rel=canonical href=https://jasonrogena.github.io/posts/2015-10-09-matatus-route-planning-using-neo4j/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Matatus; Route Planning Using Neo4J"><meta property="og:description" content="I have, for a year now, been trying to make an Opensource matatu transit application on Android for Nairobi. I must say, it has not been easy. I made some bad decisions. Some that have lead to me barking on the provabial wrong tree. I will, in this blog post, expound on one of the mistakes I made, my initial reasoning behind making this &lsquo;silly&rsquo; decision and why I was wrong."><meta property="og:type" content="article"><meta property="og:url" content="https://jasonrogena.github.io/posts/2015-10-09-matatus-route-planning-using-neo4j/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-10-09T00:00:00+00:00"><meta property="article:modified_time" content="2015-10-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Matatus; Route Planning Using Neo4J"><meta name=twitter:description content="I have, for a year now, been trying to make an Opensource matatu transit application on Android for Nairobi. I must say, it has not been easy. I made some bad decisions. Some that have lead to me barking on the provabial wrong tree. I will, in this blog post, expound on one of the mistakes I made, my initial reasoning behind making this &lsquo;silly&rsquo; decision and why I was wrong."><link rel=stylesheet href=https://jasonrogena.github.io/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://jasonrogena.github.io/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://jasonrogena.github.io/posts/2014-10-13-simple-localization-on-android/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i></a></li><li><a class=icon href=https://jasonrogena.github.io/posts/2016-01-02-heka-influxdb-and-grafana/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&text=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&title=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&is_video=false&description=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Matatus%3b%20Route%20Planning%20Using%20Neo4J&body=Check out this article: https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&title=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&title=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&name=Matatus%3b%20Route%20Planning%20Using%20Neo4J&description=I%20have%2c%20for%20a%20year%20now%2c%20been%20trying%20to%20make%20an%20Opensource%20matatu%20transit%20application%20on%20Android%20for%20Nairobi.%20I%20must%20say%2c%20it%20has%20not%20been%20easy.%20I%20made%20some%20bad%20decisions.%20Some%20that%20have%20lead%20to%20me%20barking%20on%20the%20provabial%20wrong%20tree.%20I%20will%2c%20in%20this%20blog%20post%2c%20expound%20on%20one%20of%20the%20mistakes%20I%20made%2c%20my%20initial%20reasoning%20behind%20making%20this%20%26lsquo%3bsilly%26rsquo%3b%20decision%20and%20why%20I%20was%20wrong." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&t=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Matatus; Route Planning Using Neo4J</h1><div class=meta><div class=postdate><time datetime="2015-10-09 00:00:00 +0000 UTC" itemprop=datePublished>2015-10-09</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/route-planning rel=tag>Route Planning</a>
,
<a class=tag-link href=/tags/shortest-path rel=tag>Shortest Path</a></div></div></header><div class=content itemprop=articleBody><p>I have, for a year now, been trying to make an Opensource <a href=https://en.wikipedia.org/wiki/Matatu>matatu</a> transit application on Android for Nairobi. I must say, it has not been easy. I made some bad decisions. Some that have lead to me barking on the provabial wrong tree. I will, in this blog post, expound on one of the mistakes I made, my initial reasoning behind making this &lsquo;silly&rsquo; decision and why I was wrong.</p><p>The Android app was initially inteded to be fully functional offline. I wanted to make it this way because my assumption was that the path selection problem for this particular case was going to be trivial (or trivial enough to run comfortably on any device). The users, definated, would have also appreciated an offile application. The consequences of making the application offline were:</p><ol><li><p>I&rsquo;d have to cache the entire GTFS dataset. That really wasn&rsquo;t a problem. The entire dataset was roughly 1.5M on the wire and 3M when dumped in an SQLite database on the device. Copying the entire dataset into an object in memory also didn&rsquo;t take long. I didn&rsquo;t bother breaking up the GTFS into chunks because this was the first prototype and I just wanted to make things work first.</p></li><li><p>The entire path selection algorithm had to be handled on the device. The agorithm was able to calculate relatively complex paths. It however took quite a bit of time calculating the more complex paths. More of this in the next paragraphs.</p></li></ol><p>My path selection algorithm I constructed is a varient of the classic <a href=https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm>Dijkstra&rsquo;s Algorithm</a>. Using the Dijkstra&rsquo;s algorithm for this use-case, of course, came with advantages and disadvantages. The biggest advantage, at least for me, was that since the algorithm is a <a href=https://en.wikipedia.org/wiki/Greedy_algorithm>greedy</a> one, there are very few cases where the algorithm is unable to get a path. This also means that the time taken to calculate paths increases with the complexity of the paths. This relationship isn&rsquo;t exponential but it&rsquo;s bad enough to warrant not using the algirithm in my use-case.</p><blockquote><p><strong>Note:</strong>
My implementation of the Dijkstra&rsquo;s algorithm was not optimized. No pre-calculations were being performed. The performance of the implementation, therefore, was not optimal and could therefore be improved. Take a look at the code if you think you can do that.</p></blockquote><p>I collected some stats on how the algorithm performed on my <a href=https://en.wikipedia.org/wiki/Nexus_5>LG Nexus 5</a>. I really wasn&rsquo;t scientific with the data collection. My main reason for collecting the stats is to illustrate how the algorithm scales given an increase in complexity of the path. Generally, and especially with matatu data, the complexity of the path increases with the distance between the start point and the end point. This is because there are more route stops involved and hence more possibilities for switching from one route to another&ndash;more edges to traverse. The graph is therefore distance between the the start and end points vs the time taken by the algorithm to calculate the best path. To make it a bit scientific, all the geo-points selected lie in a single road.</p><div><a href=https://plot.ly/~jasonrogena/22/ target=_blank title="Performance in Android App" style=display:block;text-align:center><img src=https://plot.ly/~jasonrogena/22.png alt="Performance in Android App" style=max-width:100%;width:936px width=936 onerror="this.onerror=null,this.src='https://plot.ly/404.png'"></a>
<script data-plotly=jasonrogena:22 src=https://plot.ly/embed.js async></script></div><p>You are better off asking around which route to take than waiting 7 minutes for phone to calculate the best path. The performace was terrible, expecially in low end devices. I figured moving the path selection code to a Jersey web service running in a Digital Ocean VPS. My idea was to run the path centrally as the web service with the Android app acting only as a frontend. Sometimes all you need to do is throw a faster CPU and more RAM at your problem. The specifications for the VPS are:</p><blockquote><p>OS: Ubuntu 14.04 x64</p><p>CPU: Intel(R) Xeon(R) CPU E5-2630L v2 @ 2.40GHz</p><p>Cores: 1</p><p>RAM: 512Mb</p></blockquote><p>Porting the code was very easy. I was getting identical results from the path selection code running on the Android app and the web service, although much faster in the web service&ndash;twenty times faster actually.</p><div><a href=https://plot.ly/~jasonrogena/24/ target=_blank title="Performance in Jersey Web Service" style=display:block;text-align:center><img src=https://plot.ly/~jasonrogena/24.png alt="Performance in Jersey Web Service" style=max-width:100%;width:936px width=936 onerror="this.onerror=null,this.src='https://plot.ly/404.png'"></a>
<script data-plotly=jasonrogena:24 src=https://plot.ly/embed.js async></script></div><p>From both the Android and Jersey web service graphs, you can tell the algorithm scales really well with path complexity. Past some complexity, the processing time levels out. My focus shifted from scaling on path complexity to scalling to the number of concurrent requests the web service could handle mainly since we were no longer using a distributed processing model.</p><p>To test how the web service handled concurrent request, I used a tool called <a href=https://www.joedog.org/siege-home>Siege</a>. Here&rsquo;s a sample siege sending 88 concurrent requests to the web service.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>siege -b -r1 -c88 <span style=color:#e6db74>&#34;http://api.ma3map.org/get/paths?from=-1.264945,36.721226&amp;to=-1.281226,36.822575&#34;</span>
</code></pre></div><div><a href=https://plot.ly/~jasonrogena/77/ target=_blank title="Performance With Increasing Concurrent Requests in Jersey Web Service" style=display:block;text-align:center><img src=https://plot.ly/~jasonrogena/77.png alt="Performance With Increasing Concurrent Requests in Jersey Web Service" style=max-width:100%;width:1187px width=1187 onerror="this.onerror=null,this.src='https://plot.ly/404.png'"></a>
<script data-plotly=jasonrogena:77 src=https://plot.ly/embed.js async></script></div><p>Up to 4 concurrent requests, the web service handles really well. However, you&rsquo;ll notice that the response time rises at a rate of 7.5 seconds with every extra request. At 5 concurrent requests, the availability drops to 0. It would be really hard to make that work in production, especially due to the fact that requests in my use-case are expected to be in pulses (during rush hours). I had to either improve the algorithm in some way, I still don&rsquo;t know how to, or adopt a different way of calculating the best path.</p><p>A colleague of mine introduced me to <a href=https://en.wikipedia.org/wiki/Neo4j>Neo4J</a> around the same time I was grappling with the problem of scaling the Jersey Webserver. A graph database (such as Neo4J) would work! At the time, I didn&rsquo;t know if it would have been faster but I was willing to try. I created a graph database with the stops as nodes and edges constructed between two nodes if these nodes share routes or are within a 2KM walking distance from each other. Path selection would involve simply querying the database for a path between the starting stop and the destination stop in the graph. It worked and it was fast, much faster than the web service. I installed the Neo4J database in the same VPS running the Jersey web service.</p><div><a href=https://plot.ly/~jasonrogena/56/ target=_blank title="Performance in Neo4J" style=display:block;text-align:center><img src=https://plot.ly/~jasonrogena/56.png alt="Performance in Neo4J" style=max-width:100%;width:1187px width=1187 onerror="this.onerror=null,this.src='https://plot.ly/404.png'"></a>
<script data-plotly=jasonrogena:56 src=https://plot.ly/embed.js async></script></div><p>It scales well to path complexity, leveling out past some complexity. Did it however scale well to increasing concurrent requests? I performed the same siege test on the Neo4J database and the results were really impressive.</p><div><a href=https://plot.ly/~jasonrogena/80/ target=_blank title="Performance With Increasing Concurrent Requests in Neo4J" style=display:block;text-align:center><img src=https://plot.ly/~jasonrogena/80.png alt="Performance With Increasing Concurrent Requests in Neo4J" style=max-width:100%;width:1187px width=1187 onerror="this.onerror=null,this.src='https://plot.ly/404.png'"></a>
<script data-plotly=jasonrogena:80 src=https://plot.ly/embed.js async></script></div><p>The graph maintained 100% availability up to 24 concurrent requests. It however did not dip to 0 at 25. The availability gradually decreased and finally zeroed out at 88 concurrent requests. What&rsquo;s interesting here is that although the availability slowly decreased, the average response time for successfull requests leveled out at 16 seconds. This is awesome.</p><p>The graph database, however, still has some issues:</p><ol><li>It&rsquo;s not as accurate as the web service.</li><li>I am still unable to use a generated graph more than once. I have to regenerate the graph every time I bring up the API that wraps around it.</li></ol><p>The next steps for me (after I solve these issues) will be to add more capabilities into the graph. Using metrics like traffic information to determine the best path is an example. The code is <a href=https://github.com/ma3map/api>here</a>. I wouldn&rsquo;t mind more contributors!</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&text=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&title=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&is_video=false&description=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Matatus%3b%20Route%20Planning%20Using%20Neo4J&body=Check out this article: https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&title=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&title=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&name=Matatus%3b%20Route%20Planning%20Using%20Neo4J&description=I%20have%2c%20for%20a%20year%20now%2c%20been%20trying%20to%20make%20an%20Opensource%20matatu%20transit%20application%20on%20Android%20for%20Nairobi.%20I%20must%20say%2c%20it%20has%20not%20been%20easy.%20I%20made%20some%20bad%20decisions.%20Some%20that%20have%20lead%20to%20me%20barking%20on%20the%20provabial%20wrong%20tree.%20I%20will%2c%20in%20this%20blog%20post%2c%20expound%20on%20one%20of%20the%20mistakes%20I%20made%2c%20my%20initial%20reasoning%20behind%20making%20this%20%26lsquo%3bsilly%26rsquo%3b%20decision%20and%20why%20I%20was%20wrong." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjasonrogena.github.io%2fposts%2f2015-10-09-matatus-route-planning-using-neo4j%2f&t=Matatus%3b%20Route%20Planning%20Using%20Neo4J" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2021 Jason Rogena</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>